# Better Probe Handling in wsd_simple_server

## Summary

Original `wsd_simple_server` only responds to Probe messages. It rejects other messages with `This is not a Probe message` error.

### How to check:

ssh into the device and run the following command:

```
wsd_simple_server -i eth0 -x http://%s/onvif/device_service -m thingino -n thingino -p /run/wsd.pid -f -d 5
```

the result will be witten into `/tmp/wsd.log` file.

```
2025-03-28 14:58:49 DEBUG wsd_simple_server.c:526: <?xml version="1.0" encoding="utf-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://www.w3.org/2003/05/soap-envelope" xmlns:SOAP-ENC="http://www.w3.org/2003/05/soap-encoding" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xop="http://www.w3.org/2004/08/xop/include" xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:tns="http://schemas.xmlsoap.org/ws/2005/04/discovery" xmlns:dn="http://www.onvif.org/ver10/network/wsdl" xmlns:wsa5="http://www.w3.org/2005/08/addressing"><SOAP-ENV:Header><wsa:MessageID>8fb5a344-41957941-547dd46f-fd3c5644-00491befcf99</wsa:MessageID><wsa:To SOAP-ENV:mustUnderstand="true">urn:schemas-xmlsoap-org:ws:2005:04:discovery</wsa:To><wsa:Action SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2005/04/discovery/NetdevProbe</wsa:Action></SOAP-ENV:Header><SOAP-ENV:Body><tns:NetdevProbe><tns:Types>dn:NetworkVideoTransmitter</tns:Types><tns:Scopes></tns:Scopes></tns:NetdevProbe></SOAP-ENV:Body></SOAP-ENV:Envelope>
2025-03-28 14:58:49 DEBUG wsd_simple_server.c:532: This is not a Probe message
2025-03-28 14:58:49 DEBUG wsd_simple_server.c:526: <?xml version="1.0" encoding="utf-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://www.w3.org/2003/05/soap-envelope" xmlns:SOAP-ENC="http://www.w3.org/2003/05/soap-encoding" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xop="http://www.w3.org/2004/08/xop/include" xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:tns="http://schemas.xmlsoap.org/ws/2005/04/discovery" xmlns:dn="http://www.onvif.org/ver10/network/wsdl" xmlns:wsa5="http://www.w3.org/2005/08/addressing"><SOAP-ENV:Header><wsa:MessageID>840bfc6d-a20fad47-e3f65a1e-75d70811-00491befcf99</wsa:MessageID><wsa:To SOAP-ENV:mustUnderstand="true">urn:schemas-xmlsoap-org:ws:2005:04:discovery</wsa:To><wsa:Action SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2005/04/discovery/UniviewProbe</wsa:Action></SOAP-ENV:Header><SOAP-ENV:Body><tns:UniviewProbe><tns:Types>dn:NetworkVideoTransmitter</tns:Types><tns:Scopes></tns:Scopes></tns:UniviewProbe></SOAP-ENV:Body></SOAP-ENV:Envelope>
2025-03-28 14:58:49 DEBUG wsd_simple_server.c:532: This is not a Probe message
2025-03-28 14:58:51 DEBUG wsd_simple_server.c:526: <?xml version="1.0" encoding="utf-8"?><Envelope xmlns:dn="http://www.onvif.org/ver10/network/wsdl" xmlns="http://www.w3.org/2003/05/soap-envelope"><Header><wsa:MessageID xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing">7ac51e70-39b3de-a71f7361-1bca9d9d-00491befcf99</wsa:MessageID><wsa:To xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:schemas-xmlsoap-org:ws:2005:04:discovery</wsa:To><wsa:Action xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2005/04/discovery/Probe</wsa:Action></Header><Body><Probe xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.xmlsoap.org/ws/2005/04/discovery"><Types>dn:NetworkVideoTransmitter</Types><Scopes /></Probe></Body><PriDescrib>dn:ZXDLLCXXJTX</PriDescrib></Envelope>
2025-03-28 14:58:51 DEBUG wsd_simple_server.c:536: Probe message
2025-03-28 14:58:51 INFO  wsd_simple_server.c:552: Sending ProbeMatches message.
2025-03-28 14:58:51 INFO  wsd_simple_server.c:584: Sent.
```

This version recognizes `Probe`, `NetdevProbe`, and `UniviewProbe` messages and responds to them.

```
level=DEBUG file=wsd_simple_server.c line=550 msg="Received WS-Discovery message from 192.168.88.30:3707"
level=DEBUG file=wsd_simple_server.c line=556 msg="Processing request from 192.168.88.30:3707"
level=DEBUG file=wsd_simple_server.c line=557 msg="Request content: <?xml version="1.0" encoding="utf-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://www.w3.org/2003/05/soap-envelope" xmlns:SOAP-ENC="http://www.w3.org/2003/05/soap-encoding" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xop="http://www.w3.org/2004/08/xop/include" xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:tns="http://schemas.xmlsoap.org/ws/2005/04/discovery" xmlns:dn="http://www.onvif.org/ver10/network/wsdl" xmlns:wsa5="http://www.w3.org/2005/08/addressing"><SOAP-ENV:Header><wsa:MessageID>e1b6d4b5-8ca66b0b-e681fab4-8217f75e-00491befcf99</wsa:MessageID><wsa:To SOAP-ENV:mustUnderstand="true">urn:schemas-xmlsoap-org:ws:2005:04:discovery</wsa:To><wsa:Action SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2005/04/discovery/NetdevProbe</wsa:Action></SOAP-ENV:Header><SOAP-ENV:Body><tns:NetdevProbe><tns:Types>dn:NetworkVideoTransmitter</tns:Types><tns:Scopes></tns:Scopes></tns:NetdevProbe></SOAP-ENV:Body></SOAP-ENV:Envelope>"
level=DEBUG file=wsd_simple_server.c line=567 msg="Accepted probe message from 192.168.88.30:3707 (method: NetdevProbe)"
level=INFO file=wsd_simple_server.c line=583 msg="Sending ProbeMatches message."
level=DEBUG file=wsd_simple_server.c line=628 msg="ProbeMatches response: <?xml version="1.0" encoding="UTF-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://www.w3.org/2003/05/soap-envelope" xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:wsdd="http://schemas.xmlsoap.org/ws/2005/04/discovery" xmlns:tdn="http://www.onvif.org/ver10/network/wsdl"><SOAP-ENV:Header><wsa:MessageID>uuid:10f81573-ce70-4a17-cc74-a67674816ef0</wsa:MessageID><wsa:RelatesTo>e1b6d4b5-8ca66b0b-e681fab4-8217f75e-00491befcf99</wsa:RelatesTo><wsa:ReplyTo SOAP-ENV:mustUnderstand="true"><wsa:Address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</wsa:Address></wsa:ReplyTo><wsa:To SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</wsa:To><wsa:Action SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2005/04/discovery/ProbeMatches</wsa:Action><wsdd:AppSequence InstanceId="0" MessageNumber="5"/></SOAP-ENV:Header><SOAP-ENV:Body><wsdd:ProbeMatches><wsdd:ProbeMatch><wsa:EndpointReference><wsa:Address>urn:uuid:087fcda9-228f-4959-4f11-f4b5b4934262</wsa:Address></wsa:EndpointReference><wsdd:Types>tdn:NetworkVideoTransmitter</wsdd:Types><wsdd:Scopes>onvif://www.onvif.org/type/video_encoder onvif://www.onvif.org/type/audio_encoder onvif://www.onvif.org/type/ptz onvif://www.onvif.org/hardware/thingino onvif://www.onvif.org/name/wyze_cam3_t31x_gc2053_rtl8189ftv onvif://www.onvif.org/location/anywhere</wsdd:Scopes><wsdd:XAddrs>http://192.168.88.201/onvif/device_service</wsdd:XAddrs><wsdd:MetadataVersion>0</wsdd:MetadataVersion></wsdd:ProbeMatch></wsdd:ProbeMatches></SOAP-ENV:Body></SOAP-ENV:Envelope>"
level=INFO file=wsd_simple_server.c line=636 msg="ProbeMatches sent to 192.168.88.30:3707"
level=DEBUG file=wsd_simple_server.c line=550 msg="Received WS-Discovery message from 192.168.88.30:3707"
level=DEBUG file=wsd_simple_server.c line=556 msg="Processing request from 192.168.88.30:3707"
level=DEBUG file=wsd_simple_server.c line=557 msg="Request content: <?xml version="1.0" encoding="utf-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://www.w3.org/2003/05/soap-envelope" xmlns:SOAP-ENC="http://www.w3.org/2003/05/soap-encoding" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xop="http://www.w3.org/2004/08/xop/include" xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:tns="http://schemas.xmlsoap.org/ws/2005/04/discovery" xmlns:dn="http://www.onvif.org/ver10/network/wsdl" xmlns:wsa5="http://www.w3.org/2005/08/addressing"><SOAP-ENV:Header><wsa:MessageID>9e0be9f3-5163327c-db84cf00-2168026-00491befcf99</wsa:MessageID><wsa:To SOAP-ENV:mustUnderstand="true">urn:schemas-xmlsoap-org:ws:2005:04:discovery</wsa:To><wsa:Action SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2005/04/discovery/UniviewProbe</wsa:Action></SOAP-ENV:Header><SOAP-ENV:Body><tns:UniviewProbe><tns:Types>dn:NetworkVideoTransmitter</tns:Types><tns:Scopes></tns:Scopes></tns:UniviewProbe></SOAP-ENV:Body></SOAP-ENV:Envelope>"
level=DEBUG file=wsd_simple_server.c line=567 msg="Accepted probe message from 192.168.88.30:3707 (method: UniviewProbe)"
level=INFO file=wsd_simple_server.c line=583 msg="Sending ProbeMatches message."
level=DEBUG file=wsd_simple_server.c line=628 msg="ProbeMatches response: <?xml version="1.0" encoding="UTF-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://www.w3.org/2003/05/soap-envelope" xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:wsdd="http://schemas.xmlsoap.org/ws/2005/04/discovery" xmlns:tdn="http://www.onvif.org/ver10/network/wsdl"><SOAP-ENV:Header><wsa:MessageID>uuid:ee9a3f95-4baa-46f6-180d-1e50806a0a1c</wsa:MessageID><wsa:RelatesTo>9e0be9f3-5163327c-db84cf00-2168026-00491befcf99</wsa:RelatesTo><wsa:ReplyTo SOAP-ENV:mustUnderstand="true"><wsa:Address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</wsa:Address></wsa:ReplyTo><wsa:To SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</wsa:To><wsa:Action SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2005/04/discovery/ProbeMatches</wsa:Action><wsdd:AppSequence InstanceId="0" MessageNumber="6"/></SOAP-ENV:Header><SOAP-ENV:Body><wsdd:ProbeMatches><wsdd:ProbeMatch><wsa:EndpointReference><wsa:Address>urn:uuid:087fcda9-228f-4959-4f11-f4b5b4934262</wsa:Address></wsa:EndpointReference><wsdd:Types>tdn:NetworkVideoTransmitter</wsdd:Types><wsdd:Scopes>onvif://www.onvif.org/type/video_encoder onvif://www.onvif.org/type/audio_encoder onvif://www.onvif.org/type/ptz onvif://www.onvif.org/hardware/thingino onvif://www.onvif.org/name/wyze_cam3_t31x_gc2053_rtl8189ftv onvif://www.onvif.org/location/anywhere</wsdd:Scopes><wsdd:XAddrs>http://192.168.88.201/onvif/device_service</wsdd:XAddrs><wsdd:MetadataVersion>0</wsdd:MetadataVersion></wsdd:ProbeMatch></wsdd:ProbeMatches></SOAP-ENV:Body></SOAP-ENV:Envelope>"
level=INFO file=wsd_simple_server.c line=636 msg="ProbeMatches sent to 192.168.88.30:3707"
level=DEBUG file=wsd_simple_server.c line=550 msg="Received WS-Discovery message from 192.168.88.30:3702"
level=DEBUG file=wsd_simple_server.c line=556 msg="Processing request from 192.168.88.30:3702"
level=DEBUG file=wsd_simple_server.c line=557 msg="Request content: <?xml version="1.0" encoding="utf-8"?><Envelope xmlns:dn="http://www.onvif.org/ver10/network/wsdl" xmlns="http://www.w3.org/2003/05/soap-envelope"><Header><wsa:MessageID xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing">9938078f-65d46e0f-bb60763f-70556441-00491befcf99</wsa:MessageID><wsa:To xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:schemas-xmlsoap-org:ws:2005:04:discovery</wsa:To><wsa:Action xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2005/04/discovery/Probe</wsa:Action></Header><Body><Probe xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns="http://schemas.xmlsoap.org/ws/2005/04/discovery"><Types>dn:NetworkVideoTransmitter</Types><Scopes /></Probe></Body><PriDescrib>dn:ZXDLLCXXJTX</PriDescrib></Envelope>"
level=DEBUG file=wsd_simple_server.c line=567 msg="Accepted probe message from 192.168.88.30:3702 (method: Probe)"
level=INFO file=wsd_simple_server.c line=583 msg="Sending ProbeMatches message."
level=DEBUG file=wsd_simple_server.c line=628 msg="ProbeMatches response: <?xml version="1.0" encoding="UTF-8"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://www.w3.org/2003/05/soap-envelope" xmlns:wsa="http://schemas.xmlsoap.org/ws/2004/08/addressing" xmlns:wsdd="http://schemas.xmlsoap.org/ws/2005/04/discovery" xmlns:tdn="http://www.onvif.org/ver10/network/wsdl"><SOAP-ENV:Header><wsa:MessageID>uuid:d8adf790-8f6a-4c2f-9bad-6b0f206c7e0b</wsa:MessageID><wsa:RelatesTo>9938078f-65d46e0f-bb60763f-70556441-00491befcf99</wsa:RelatesTo><wsa:ReplyTo SOAP-ENV:mustUnderstand="true"><wsa:Address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</wsa:Address></wsa:ReplyTo><wsa:To SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</wsa:To><wsa:Action SOAP-ENV:mustUnderstand="true">http://schemas.xmlsoap.org/ws/2005/04/discovery/ProbeMatches</wsa:Action><wsdd:AppSequence InstanceId="0" MessageNumber="7"/></SOAP-ENV:Header><SOAP-ENV:Body><wsdd:ProbeMatches><wsdd:ProbeMatch><wsa:EndpointReference><wsa:Address>urn:uuid:087fcda9-228f-4959-4f11-f4b5b4934262</wsa:Address></wsa:EndpointReference><wsdd:Types>tdn:NetworkVideoTransmitter</wsdd:Types><wsdd:Scopes>onvif://www.onvif.org/type/video_encoder onvif://www.onvif.org/type/audio_encoder onvif://www.onvif.org/type/ptz onvif://www.onvif.org/hardware/thingino onvif://www.onvif.org/name/wyze_cam3_t31x_gc2053_rtl8189ftv onvif://www.onvif.org/location/anywhere</wsdd:Scopes><wsdd:XAddrs>http://192.168.88.201/onvif/device_service</wsdd:XAddrs><wsdd:MetadataVersion>0</wsdd:MetadataVersion></wsdd:ProbeMatch></wsdd:ProbeMatches></SOAP-ENV:Body></SOAP-ENV:Envelope>"
level=INFO file=wsd_simple_server.c line=636 msg="ProbeMatches sent to 192.168.88.30:3702"
```